"use strict";var J=Object.create;var v=Object.defineProperty;var Q=Object.getOwnPropertyDescriptor;var V=Object.getOwnPropertyNames;var X=Object.getPrototypeOf,Y=Object.prototype.hasOwnProperty;var R=(t,e)=>{for(var n in e)v(t,n,{get:e[n],enumerable:!0})},O=(t,e,n,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let o of V(e))!Y.call(t,o)&&o!==n&&v(t,o,{get:()=>e[o],enumerable:!(r=Q(e,o))||r.enumerable});return t};var D=(t,e,n)=>(n=t!=null?J(X(t)):{},O(e||!t||!t.__esModule?v(n,"default",{value:t,enumerable:!0}):n,t)),ee=t=>O(v({},"__esModule",{value:!0}),t);var we={};R(we,{Bot:()=>S,BotSpecificClient:()=>u,Integration:()=>x,IntegrationDefinition:()=>B,IntegrationSpecificClient:()=>T,botIdHeader:()=>h,botUserIdHeader:()=>E,configurationHeader:()=>m,integrationIdHeader:()=>w,messages:()=>P,operationHeader:()=>y,parseBody:()=>p,serve:()=>f,typeHeader:()=>U,webhookIdHeader:()=>M});module.exports=ee(we);var P={};R(P,{defaults:()=>ce});var a=require("zod"),g=a.z.string().min(1),te=a.z.object({text:g}),ne=a.z.object({markdown:g}),oe=a.z.object({imageUrl:g}),se=a.z.object({audioUrl:g}),re=a.z.object({videoUrl:g}),ae=a.z.object({fileUrl:g,title:g.optional()}),ie=a.z.object({latitude:a.z.number(),longitude:a.z.number(),address:a.z.string().optional(),title:a.z.string().optional()}),G=a.z.object({title:g,subtitle:g.optional(),imageUrl:g.optional(),actions:a.z.array(a.z.object({action:a.z.enum(["postback","url","say"]),label:g,value:g}))}),F=a.z.object({text:g,options:a.z.array(a.z.object({label:g,value:g}))}),ge=a.z.object({items:a.z.array(G)}),ce={text:{schema:te},markdown:{schema:ne},image:{schema:oe},audio:{schema:se},video:{schema:re},file:{schema:ae},location:{schema:ie},carousel:{schema:ge},card:{schema:G},dropdown:{schema:F},choice:{schema:F}};var h="x-bot-id",E="x-bot-user-id",w="x-integration-id",M="x-webhook-id",m="x-bp-configuration",y="x-bp-operation",U="x-bp-type";var _=require("node:http");var d=console;function p(t){if(!t.body)throw new Error("Missing body");return JSON.parse(t.body)}async function f(t,e=8072,n=Te){let r=(0,_.createServer)(async(o,s)=>{try{let i=await pe(o);if(i.path==="/health"){s.writeHead(200).end("ok");return}let c=await t(i);s.writeHead(c?.status??200,c?.headers??{}).end(c?.body??"{}")}catch(i){d.error("Error while handling request",{error:i?.message??"Internal error occured"}),s.writeHead(500).end(JSON.stringify({error:i?.message??"Internal error occured"}))}});return r.listen(e,()=>n(e)),r}async function pe(t){let e=await de(t),n={};for(let o=0;o<t.rawHeaders.length;o+=2){let s=t.rawHeaders[o].toLowerCase(),i=t.rawHeaders[o+1];n[s]=i}let r=new URL(t.url??"",t.headers.host?`http://${t.headers.host}`:"http://botpress.cloud");return{body:e,path:r.pathname,query:le(r.search,"?"),headers:n,method:t.method?.toUpperCase()??"GET"}}function le(t,e){return t.indexOf(e)===0?t.slice(e.length):t}async function de(t){return new Promise((e,n)=>{if(t.method!=="POST"&&t.method!=="PUT"&&t.method!=="PATCH")return e(void 0);let r="";t.on("data",o=>r+=o.toString()),t.on("error",o=>n(o)),t.on("end",()=>e(r))})}function Te(t){d.info(`Listening on port ${t}`)}var L=require("zod");var ue=L.z.enum(["webhook_received","message_created","action_triggered","register","unregister","ping","create_user","create_conversation"]),K=t=>{let e=t[h],n=t[E],r=t[w],o=t[M],s=t[m],i=ue.parse(t[y]);if(!e)throw new Error("Missing bot headers");if(!n)throw new Error("Missing bot user headers");if(!r)throw new Error("Missing integration headers");if(!o)throw new Error("Missing webhook headers");if(!s)throw new Error("Missing configuration headers");if(!i)throw new Error("Missing operation headers");return{botId:e,botUserId:n,integrationId:r,webhookId:o,operation:i,configuration:s?JSON.parse(Buffer.from(s,"base64").toString("utf-8")):{}}};var B=class{constructor(e){this.props=e;this.name=e.name,this.version=e.version,this.icon=e.icon,this.readme=e.readme,this.title=e.title,this.identifier=e.identifier,this.description=e.description,this.configuration=e.configuration,this.events=e.events,this.actions=e.actions,this.channels=e.channels,this.states=e.states,this.user=e.user,this.secrets=e.secrets,this.entities=e.entities}name;version;title;description;icon;readme;configuration;events;actions;channels;states;user;secrets;identifier;entities};var C=require("@botpress/client");var T=class{constructor(e){this.client=e}createConversation=e=>this.client.createConversation(e);getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);createEvent=e=>this.client.createEvent(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);createUser=e=>this.client.createUser(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);getOrCreateUser=e=>this.client.getOrCreateUser(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e);setState=e=>this.client.setState(e);getOrSetState=e=>this.client.getOrSetState(e);patchState=e=>this.client.patchState(e);configureIntegration=e=>this.client.configureIntegration(e)};var k=D(require("util")),b=t=>{if(process.env.BP_LOG_FORMAT==="json")return JSON.stringify({msg:k.default.format(...t),visible_to_bot_owner:!0});{let[e,...n]=t;return k.default.format(`[For Bot Owner] ${e}`,...n)}},j={forBot:()=>({info:(...t)=>{console.info(b(t))},warn:(...t)=>{console.warn(b(t))},error:(...t)=>{console.error(b(t))},debug:(...t)=>{console.debug(b(t))}})};var q=t=>async e=>{let n=K(e.headers),r=new T(new C.Client({botId:n.botId,integrationId:n.integrationId})),o={ctx:n,req:e,client:r,logger:j,instance:t};try{let s;switch(n.operation){case"webhook_received":s=await he(o);break;case"register":s=await me(o);break;case"unregister":s=await ye(o);break;case"message_created":s=await Be(o);break;case"action_triggered":s=await be(o);break;case"ping":s=await Ie(o);break;case"create_user":s=await fe(o);break;case"create_conversation":s=await ve(o);break;default:throw new Error(`Unknown operation ${n.operation}`)}return s?{...s,status:s.status??200}:{status:200}}catch(s){if(s instanceof C.RuntimeError)return{status:s.code,body:JSON.stringify(s.toJSON())};throw s}},Ie=async t=>{},he=async({client:t,ctx:e,req:n,logger:r,instance:o})=>{let{req:s}=p(n);return o.webhook({client:t,ctx:e,req:s,logger:r})},me=async({client:t,ctx:e,req:n,logger:r,instance:o})=>{if(!o.register)return;let{webhookUrl:s}=p(n);await o.register({client:t,ctx:e,webhookUrl:s,logger:r})},ye=async({client:t,ctx:e,req:n,logger:r,instance:o})=>{if(!o.unregister)return;let{webhookUrl:s}=p(n);await o.unregister({ctx:e,webhookUrl:s,client:t,logger:r})},fe=async({client:t,ctx:e,req:n,logger:r,instance:o})=>{if(!o.createUser)return;let{tags:s}=p(n);return await o.createUser({ctx:e,client:t,tags:s,logger:r})},ve=async({client:t,ctx:e,req:n,logger:r,instance:o})=>{if(!o.createConversation)return;let{channel:s,tags:i}=p(n);return await o.createConversation({ctx:e,client:t,channel:s,tags:i,logger:r})},Be=async({ctx:t,req:e,client:n,logger:r,instance:o})=>{let{conversation:s,user:i,type:c,payload:I,message:l}=p(e),A=o.channels[s.channel];if(!A)throw new Error(`Channel ${s.channel} not found`);let H=A.messages[c];if(!H)throw new Error(`Message of type ${c} not found in channel ${s.channel}`);await H({ctx:t,conversation:s,message:l,user:i,type:c,client:n,payload:I,ack:async({tags:W})=>{await n.updateMessage({id:l.id,tags:W})},logger:r})},be=async({req:t,ctx:e,client:n,logger:r,instance:o})=>{let{input:s,type:i}=p(t);if(!i)throw new Error("Missing action type");let c=o.actions[i];if(!c)throw new Error(`Action ${i} not found`);let I=await c({ctx:e,input:s,client:n,type:i,logger:r});return{body:JSON.stringify({output:I})}};var x=class{props;actions;channels;register;unregister;createUser;createConversation;webhook;constructor(e){this.props=e,this.actions=e.actions,this.channels=e.channels,this.register=e.register,this.unregister=e.unregister,this.createUser=e.createUser,this.createConversation=e.createConversation,this.webhook=e.handler}handler=q(this);start=e=>f(this.handler,e)};var Z=D(require("@botpress/client"));var u=class{constructor(e){this.client=e}getConversation=e=>this.client.getConversation(e);listConversations=e=>this.client.listConversations(e);updateConversation=e=>this.client.updateConversation(e);deleteConversation=e=>this.client.deleteConversation(e);listParticipants=e=>this.client.listParticipants(e);addParticipant=e=>this.client.addParticipant(e);getParticipant=e=>this.client.getParticipant(e);removeParticipant=e=>this.client.removeParticipant(e);getEvent=e=>this.client.getEvent(e);listEvents=e=>this.client.listEvents(e);createMessage=e=>this.client.createMessage(e);getOrCreateMessage=e=>this.client.getOrCreateMessage(e);getMessage=e=>this.client.getMessage(e);updateMessage=e=>this.client.updateMessage(e);listMessages=e=>this.client.listMessages(e);deleteMessage=e=>this.client.deleteMessage(e);getUser=e=>this.client.getUser(e);listUsers=e=>this.client.listUsers(e);updateUser=e=>this.client.updateUser(e);deleteUser=e=>this.client.deleteUser(e);getState=e=>this.client.getState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));setState=e=>this.client.setState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));getOrSetState=e=>this.client.getOrSetState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));patchState=e=>this.client.patchState(e).then(n=>({state:{...n.state,payload:n.state.payload}}));callAction=e=>this.client.callAction(e);createConversation=e=>this.client.createConversation(e);getOrCreateConversation=e=>this.client.getOrCreateConversation(e);createUser=e=>this.client.createUser(e);getOrCreateUser=e=>this.client.getOrCreateUser(e)};var $=require("zod");var Ce=$.z.enum(["event_received","register","unregister","ping","action_triggered"]),N=t=>{let e=t[h],n=t[m],r=t[U],o=Ce.parse(t[y]);if(!e)throw new Error("Missing bot headers");if(!r)throw new Error("Missing type headers");if(!n)throw new Error("Missing configuration headers");if(!o)throw new Error("Missing operation headers");return{botId:e,operation:o,type:r,configuration:n?JSON.parse(Buffer.from(n,"base64").toString("utf-8")):{}}};var z=t=>async e=>{let n=N(e.headers);n.operation!=="ping"&&d.info(`Received ${n.operation} operation for bot ${n.botId} of type ${n.type}`);let r=new u(new Z.Client({botId:n.botId})),o={req:e,ctx:n,client:r,instance:t};switch(n.operation){case"action_triggered":throw new Error(`Operation ${n.operation} not supported yet`);case"event_received":await Ee(o);break;case"register":await Se(o);break;case"unregister":await Pe(o);break;case"ping":await xe(o);break;default:throw new Error(`Unknown operation ${n.operation}`)}return{status:200}},xe=async t=>{},Se=async t=>{},Pe=async t=>{},Ee=async({ctx:t,req:e,client:n,instance:r})=>{d.debug(`Received event ${t.type}`);let o=p(e),s=o.event;switch(t.type){case"message_created":let i={user:s.payload.user,conversation:s.payload.conversation,message:s.payload.message,states:s.payload.states,event:s};await Promise.all(r.messageHandlers.map(l=>l({client:n,ctx:t,...i})));break;case"state_expired":let c={state:s.payload.state};await Promise.all(r.stateExpiredHandlers.map(l=>l({client:n,ctx:t,...c})));break;default:let I={event:o.event};await Promise.all(r.eventHandlers.map(l=>l({client:n,ctx:t,...I})))}};var S=class{_state={messageHandlers:[],eventHandlers:[],stateExpiredHandlers:[]};props;constructor(e){this.props=e}message=e=>{this._state.messageHandlers.push(e)};event=e=>{this._state.eventHandlers.push(e)};stateExpired=e=>{this._state.stateExpiredHandlers.push(e)};handler=z(this._state);start=e=>f(this.handler,e)};0&&(module.exports={Bot,BotSpecificClient,Integration,IntegrationDefinition,IntegrationSpecificClient,botIdHeader,botUserIdHeader,configurationHeader,integrationIdHeader,messages,operationHeader,parseBody,serve,typeHeader,webhookIdHeader});
//# sourceMappingURL=index.js.map
